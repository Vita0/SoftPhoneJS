<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
<head>
    <title>TODO supply a title</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <script src="SIPml-api.js?svn=230" type="text/javascript"></script>
    <script>
        var sipStack;
        var registerSession;
        var callSession;
        var audioRemote = document.getElementById('audio_remote');

        function startRingTone() {
            try { ringtone.play(); }
            catch (e) { }
        }
        function stopRingTone() {
            try { ringtone.pause(); }
            catch (e) { }
        }
        function startRingbackTone() {
            try { ringbacktone.play(); }
            catch (e) { }
        }
        function stopRingbackTone() {
            try { ringbacktone.pause(); }
            catch (e) { }
        }

        function createSipStack(){
            console.log("createSipStack 1");
            sipStack = new SIPml.Stack({
                    realm: '192.168.0.105',
                    impi: '103',
                    impu: 'sip:103@192.168.0.105',
                    password: '103pas',
                    websocket_proxy_url: 'ws://192.168.0.105:8088/ws',
                    ice_servers: "[{ url: 'stun:stun.l.google.com:19302'}]",
                    enable_rtcweb_breaker: false,
                    events_listener: { events: '*', listener: onSipEventStack }, // optional: '*' means all events
                    sip_headers: [ // optional
                            { name: 'User-Agent', value: 'IM-client/OMA1.0 sipML5-v1.0.0.0' },
                            { name: 'Organization', value: 'TODO' }
                    ]
                }
            );
            console.log("createSipStack 2");
        }

        var readyCallback = function(e){
            createSipStack();
            console.info('sipml5 is ready');
        };
        var errorCallback = function(e){
            console.error('Failed to initialize the engine: ' + e.message);
        }

        function register(){
            console.log("register 1");
            SIPml.init(readyCallback, errorCallback);//createSipStack
            sipStack.start(); //event 'started', register
            console.log("register 2");
        }

        function onSipEventStack(e){
            console.log("onSipEventStack 1, type = " + e.type);
            switch (e.type) {
                case 'started':
                { //register
                    registerSession = sipStack.newSession('register', {
                        events_listener: { events: '*', listener: onSipEventSession } // optional: '*' means all events
                    });
                    registerSession.register();
                    break;
                }
                case 'i_new_message': // incoming new SIP MESSAGE (SMS-like)
                {
                    acceptMessage(e);
                    break;
                }
                case 'i_new_call': // incoming audio/video call
                {
                    if (callSession) {
                        // do not accept the incoming call if we're already 'in call'
                        e.newSession.hangup(); // comment this line for multi-line support
                    }
                    else {
                        callSession = e.newSession;
                        // start listening for events
                        callSession.setConfiguration({
                                audio_remote: document.getElementById('audio_remote'),
                                events_listener: { events: '*', listener: onSipEventSession } // optional: '*' means all events
                            });

                        btnCall.value = 'Answer';
                        btnHangUp.value = 'Reject';

                        startRingTone();
                    }
                    break;
                }
            }
            console.log("onSipEventStack 2");
        }

        function onSipEventSession(e){
            console.log("onSipEventSession 1");
            console.info('session event = ' + e.type);
            switch (e.type)
            {
                case 'connecting': case 'connected':
                {
                    var bConnected = (e.type == 'connected');
                    if (e.session == registerSession) {
                        txtRegStatus.innerHTML = "<i>" + e.description + "</i>";
                    }
                    else if (e.session == registerSession) {
                        if (bConnected) {
                            stopRingbackTone();
                            stopRingTone();

                            if (oNotifICall) {
                                oNotifICall.cancel();
                                oNotifICall = null;
                            }
                        }
                        txtCallStatus.innerHTML = "<i>" + e.description + "</i>";
                    }
                    break;
                } // 'connecting' | 'connected'
            }
            console.log("onSipEventSession 2");
        }

        function eventsListener(e){
            console.info('session event = ' + e.type);
        }

        function call(){
            console.log("call 1");
            if (!callSession) {
                callSession = sipStack.newSession('call-audio', {
                        audio_remote: document.getElementById('audio_remote'),
                        events_listener: { events: '*', listener: onSipEventSession } // optional: '*' means all events
                    });
                callSession.call('101');
            }
            else {
                //todo
                txtCallStatus.innerHTML = '<i>Connecting...</i>';
                callSession.accept();
                stopRingTone();
                //callSession.hangup();
            }
            console.log("call 2");
        }
        
        
    </script>

    <input type="button" id="btnRegister" value="Register" onclick='register();' />
    <input type="button" id="btnCall" value="Call 101" onclick='call();' />
    <input type="button" id="btnHangUp" value="HangUp" onclick='hangup();' />
    <input type="button" id="btnUnRegister" value="Answer" onclick='unregister();' />
    <p>
        статус регистрации:&nbsp;
        <label id="txtRegStatus"></label>
    </p>
    <p>
        статус звонка:&nbsp;
        <label id="txtCallStatus"></label>
    </p>

    <!-- <audio id="audio_remote" autoplay="autoplay" ></audio> -->
    <audio id="audio_remote" autoplay="autoplay" />
    <audio id="ringtone" loop src="sounds/ringtone.wav" />
    <audio id="ringbacktone" loop src="sounds/ringbacktone.wav" />
</body>
</html>
